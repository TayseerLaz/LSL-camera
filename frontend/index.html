<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Sign Language Detection</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      background-color: #002D4A;
    }
    #video {
      object-fit: cover;
    }
  </style>
</head>

<body class="relative font-[Poppins] text-white">
  <!-- Language selection -->
  <div id="language-selection" class="absolute inset-0 flex flex-col items-center justify-center bg-[#002D4A] z-50">
    <h1 class="text-3xl font-bold mb-6">Choose Sign Language</h1>
    <div class="flex gap-6">
      <button onclick="startDetection('en')" class="bg-[#0194A0] hover:bg-teal-700 px-6 py-3 rounded-xl text-lg font-semibold shadow-md">English</button>
      <button onclick="startDetection('ar')" class="bg-[#0194A0] hover:bg-teal-700 px-6 py-3 rounded-xl text-lg font-semibold shadow-md">Arabic</button>
    </div>
  </div>

  <!-- Back button -->
  <button id="back-button" onclick="goBackToLanguageSelection()" class="absolute top-4 left-4 bg-white text-[#002D4A] px-4 py-2 rounded-xl shadow-lg z-50 font-semibold hover:bg-gray-100 hidden">← Back</button>

  <!-- Video -->
  <video id="video" autoplay playsinline class="w-full h-full hidden"></video>

  <!-- Prediction display -->
  <div id="result" class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-white text-[#002D4A] px-5 py-2 rounded-xl shadow-xl text-lg font-semibold z-40 hidden">
    Prediction: ...
  </div>

  <script>
    const video = document.getElementById("video");
    const result = document.getElementById("result");
    const languageSelection = document.getElementById("language-selection");
    const backButton = document.getElementById("back-button");

    let selectedLanguage = null;
    let stream = null;
    let isPredicting = false;
    const BACKEND_URL = "https://lsl-camera-little-glade-2085.fly.dev/predict"; // ← FIXED URL

    function startDetection(lang) {
      selectedLanguage = lang;
      languageSelection.classList.add("hidden");
      video.classList.remove("hidden");
      result.classList.remove("hidden");
      backButton.classList.remove("hidden");
      result.innerText = `Starting detection in ${lang.toUpperCase()}...`;
      startCamera();
    }

    function goBackToLanguageSelection() {
      video.classList.add("hidden");
      result.classList.add("hidden");
      backButton.classList.add("hidden");
      languageSelection.classList.remove("hidden");
      selectedLanguage = null;
      if (stream) {
        stream.getTracks().forEach((track) => track.stop());
        stream = null;
      }
    }

    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { width: { ideal: 640 }, height: { ideal: 480 }, facingMode: "user" }
        });
        video.srcObject = stream;

        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");

        video.onloadedmetadata = () => {
          requestAnimationFrame(predictFrame);
        };

        async function predictFrame() {
          if (!selectedLanguage || isPredicting || video.videoWidth === 0) {
            requestAnimationFrame(predictFrame);
            return;
          }

          isPredicting = true;

          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

          const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/jpeg", 0.8));
          const formData = new FormData();
          formData.append("file", blob, "frame.jpg");
          formData.append("language", selectedLanguage);

          try {
            const response = await fetch(BACKEND_URL, {
              method: "POST",
              body: formData,
            });

            if (!response.ok) throw new Error("Failed to get prediction");

            const json = await response.json();
            const label = selectedLanguage === "ar" ? "الترجمة" : "Prediction";
            result.innerText = `${label}: ${json.prediction} (${(json.confidence * 100).toFixed(2)}%)`;
          } catch (err) {
            console.error("Prediction error:", err);
            result.innerText = "Prediction: Server error.";
          } finally {
            isPredicting = false;
            requestAnimationFrame(predictFrame);
          }
        }
      } catch (err) {
        result.innerText = "Error accessing camera: " + err.message;
        console.error("Camera error:", err);
      }
    }
  </script>
</body>
</html>
