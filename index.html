<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>ASL Detection</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body,
    html {
      margin: 0;
      padding: 0;
      height: 100%;
      background-color: #002D4A;
    }

    #video {
      object-fit: cover;
    }
  </style>
</head>

<body class="relative font-[Poppins] text-white">

  <!-- Language selection overlay -->
  <div id="language-selection"
    class="absolute inset-0 flex flex-col items-center justify-center bg-[#002D4A] text-white z-50">
    <h1 class="text-3xl font-bold mb-6 text-center">Choose Sign Language</h1>
    <div class="flex gap-6">
      <button onclick="startDetection('en')"
        class="bg-[#0194A0] hover:bg-teal-700 px-6 py-3 rounded-xl text-lg font-semibold shadow-md transition-all duration-200">English</button>
      <button onclick="startDetection('ar')"
        class="bg-[#0194A0] hover:bg-teal-700 px-6 py-3 rounded-xl text-lg font-semibold shadow-md transition-all duration-200">Arabic</button>
    </div>
  </div>

  <!-- Back button -->
  <button onclick="goBackToLanguageSelection()"
    class="absolute top-4 left-4 bg-white text-[#002D4A] px-4 py-2 rounded-xl shadow-lg z-50 font-semibold hover:bg-gray-100 transition hidden"
    id="back-button">
    ← Back
  </button>

  <!-- Fullscreen video -->
  <video id="video" autoplay playsinline class="w-full h-full hidden"></video>

  <!-- Prediction result overlay -->
  <div id="result"
    class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-white text-[#002D4A] px-5 py-2 rounded-xl shadow-xl text-lg font-semibold z-40 hidden">
    Prediction: ...
  </div>

  <script>
    const video = document.getElementById('video');
    const result = document.getElementById('result');
    const languageSelection = document.getElementById('language-selection');
    const backButton = document.getElementById('back-button');
    let selectedLanguage = null;
    let isFetching = false;
    let stream = null;

    function startDetection(lang) {
      selectedLanguage = lang;
      languageSelection.classList.add('hidden');
      video.classList.remove('hidden');
      result.classList.remove('hidden');
      backButton.classList.remove('hidden');
      result.innerText = `Starting detection in ${lang.toUpperCase()}...`;
      startCamera();
    }

    function goBackToLanguageSelection() {
      // Hide current UI
      video.classList.add('hidden');
      result.classList.add('hidden');
      backButton.classList.add('hidden');
      languageSelection.classList.remove('hidden');
      selectedLanguage = null;

      // Stop camera if active
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
    }

    async function fetchWithTimeout(url, options = {}, timeout = 5000) {
      return Promise.race([
        fetch(url, options),
        new Promise((_, reject) => setTimeout(() => reject(new Error("Request timed out")), timeout))
      ]);
    }

    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { exact: "environment" } }
        });
        video.srcObject = stream;

        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        setInterval(async () => {
          if (!selectedLanguage || isFetching) return;
          isFetching = true;

          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

          const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg'));
          const formData = new FormData();
          formData.append('file', blob, 'frame.jpg');
          formData.append('language', selectedLanguage);

          try {
            const response = await fetchWithTimeout('https://8c26-185-127-183-100.ngrok-free.app/predict', {
              method: 'POST',
              body: formData
            }, 5000);
            const json = await response.json();
            const label = selectedLanguage === 'ar' ? 'الترجمة' : 'Prediction';
            result.innerText = `${label}: ${json.prediction} (${(json.confidence * 100).toFixed(2)}%)`;
          } catch (error) {
            result.innerText = "Prediction: Error connecting to server.";
            console.error("Fetch error:", error);
          } finally {
            isFetching = false;
          }
        }, 1000);
      } catch (err) {
        result.innerText = "Error accessing camera: " + err.message;
        console.error("Camera error:", err);
      }
    }
  </script>
</body>

</html>